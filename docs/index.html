<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Joust Game â€” CheerpJ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Use CheerpJ 4.1 - correct loader script -->
  <script src="https://cjrtnc.leaningtech.com/4.1/loader.js"></script>
</head>

<body>
  <div id="loading">Loading Java gameâ€¦ <br><small>If stuck, refresh the page (F5)</small></div>
  <div id="instructions">Click on the game to enable keyboard controls (Arrow Keys + Space)</div>
  <div id="gameContainer"></div>

  <!--  Use a module so we can 'await' cheerpjInit()                    -->
  <script type="module">
    try {
      console.log('Starting CheerpJ with performance optimizationsâ€¦');
      
      // Performance-optimized CheerpJ initialization
      await cheerpjInit({
        version: 11,
        enablePreciseAppletSizeWorkaround: false,
        clipboardMode: "system",
        preloadProgress: function(current, total) {
          if(total > 0) {
            const percent = Math.round((current / total) * 100);
            document.getElementById('loading').innerHTML = 
              `Loading Java gameâ€¦ ${percent}% <br><small>If stuck, refresh the page (F5)</small>`;
          }
        },
        // Performance optimizations
        javaProperties: [
          "-Dsun.java2d.opengl=true",  // Enable hardware acceleration
          "-Dsun.java2d.d3d=true",     // Enable Direct3D
          "-XX:+AggressiveOpts",       // Aggressive optimizations
          "-XX:+UseConcMarkSweepGC"    // Better garbage collection
        ]
      });

      console.log('Creating optimized AWT/Swing displayâ€¦');
      
      // Precise canvas creation with container targeting
      const container = document.getElementById('gameContainer');
      cheerpjCreateDisplay(800, 850, container);
      
      // Wait a moment for canvas creation
      await new Promise(resolve => setTimeout(resolve, 500));

      console.log('Running game JARâ€¦');
      await cheerpjRunJar("/app/KallenSelbyJoustGame/JoustGame.jar");

      // Enhanced key event handling with performance focus
      console.log('Setting up optimized key event handlersâ€¦');
      
      const canvas = document.querySelector('canvas');
      if (canvas) {
        // Ensure exact canvas sizing
        canvas.width = 800;
        canvas.height = 850;
        canvas.style.width = '800px';
        canvas.style.height = '850px';
        
        canvas.tabIndex = 0;
        canvas.focus();
        
        // Optimized event handling
        const keyHandler = function(e) {
          if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Space', 'KeyN'].includes(e.code)) {
            e.preventDefault();
            e.stopPropagation();
          }
        };
        
        canvas.addEventListener('keydown', keyHandler, { passive: false });
        canvas.addEventListener('keyup', keyHandler, { passive: false });
        
        canvas.addEventListener('click', function() {
          this.focus();
          document.getElementById('instructions').style.opacity = '0.5';
        });
        
        canvas.addEventListener('blur', function() {
          document.getElementById('instructions').style.opacity = '1';
        });
        
        // Force focus every few seconds to ensure responsiveness
        setInterval(() => {
          if (document.activeElement !== canvas) {
            canvas.focus();
          }
        }, 3000);
      }

      document.getElementById('loading').style.display = 'none';
      
    } catch (e) {
      console.error('CheerpJ Error:', e);
      document.getElementById('loading').innerHTML =
        `<div style="color: #ff6b6b;">Error: ${e.message}</div>
         <div style="font-size: 14px; margin-top: 10px;">
           Try refreshing the page (F5) or check console for details.
         </div>`;
    }
  </script>

  <style>
    html, body {
      margin: 0;
      padding: 10px;
      min-height: 100vh;
      background: #111;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-family: 'Arial', sans-serif;
      color: #fff;
    }
    
    #loading {
      color: #fff;
      font-size: 18px;
      margin-bottom: 20px;
      text-align: center;
    }
    
    #loading small {
      color: #ffeb3b;
      font-size: 12px;
      display: block;
      margin-top: 5px;
    }
    
    #instructions {
      color: #ffeb3b;
      background: rgba(0,0,0,0.9);
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 15px;
      text-align: center;
      border: 2px solid #ffeb3b;
      transition: opacity 0.3s ease;
      max-width: 800px;
      box-shadow: 0 0 10px rgba(255,235,59,0.3);
    }
    
    #gameContainer {
      border: 3px solid #555;
      background: #000;
      box-shadow: 0 0 30px rgba(255,255,255,0.1);
      position: relative;
      /* Exact sizing to prevent offset */
      width: 800px;
      height: 850px;
      overflow: hidden;
    }
    
    /* Ensure canvas perfect positioning */
    canvas {
      outline: none !important;
      display: block !important;
      position: relative !important;
      /* Force exact dimensions */
      width: 800px !important;
      height: 850px !important;
      margin: 0 !important;
      padding: 0 !important;
      border: none !important;
    }
    
    /* Performance hint */
    #gameContainer::before {
      content: "ðŸŽ® Optimized for Performance";
      position: absolute;
      top: -25px;
      left: 0;
      color: #4caf50;
      font-size: 11px;
      font-weight: bold;
    }
    
    /* Responsive design for smaller screens */
    @media (max-width: 850px) {
      #gameContainer {
        transform: scale(0.9);
        transform-origin: center;
        width: 720px;
        height: 765px;
      }
      
      canvas {
        width: 720px !important;
        height: 765px !important;
      }
    }
    
    @media (max-width: 750px) {
      #gameContainer {
        transform: scale(0.8);
        width: 640px;
        height: 680px;
      }
      
      canvas {
        width: 640px !important;
        height: 680px !important;
      }
    }
  </style>
</body>
</html>
