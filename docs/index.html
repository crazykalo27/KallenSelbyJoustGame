<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Joust Game â€” CheerpJ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Use CheerpJ 4.1 -->
  <script src="https://cjrtnc.leaningtech.com/4.1/loader.js"></script>
</head>

<body>
  <div id="loading">Loading Java gameâ€¦ <br><small>If stuck, refresh the page (F5)</small></div>
  <div id="instructions">Click on the game to enable keyboard controls (Arrow Keys + Space)</div>
  <div id="gameContainer"></div>

  <script type="module">
    try {
      console.log('Starting CheerpJ with MAXIMUM performance optimizationsâ€¦');

      await cheerpjInit({
        version: "4.1",                          // match your loader
        enablePreciseAppletSizeWorkaround: true, 
        clipboardMode: "system",
        enableInputMethods: false,
        
        // Offload heavy compute into a Web Worker
        useWorkers: true,

        // Enable the WebAssembly JIT engine
        wasm: true,

        // Show % loading
        preloadProgress(current, total) {
          if (total > 0) {
            const p = Math.round((current/total)*100);
            document.getElementById('loading').innerHTML =
              `Loading Java gameâ€¦ ${p}% <br><small>If stuck, refresh (F5)</small>`;
          }
        },

        // Kick off parallel download of exactly the modules you need
        preloadResources: await (async()=>{
          // discover which modules you actually use
          const list = JSON.parse(cjGetRuntimeResources());
          // you might filter here if you know some are optional
          return list;
        })(),

        // JVM flags tuned for max throughput
        javaProperties: [
          "-Dsun.java2d.opengl=true",      
          "-Dsun.java2d.d3d=true",         
          "-XX:+AggressiveOpts",           
          "-XX:+UseConcMarkSweepGC",       
          "-XX:+UseCompressedOops",        
          "-Dsun.java2d.noddraw=false",    
          "-Dsun.java2d.ddforcevram=true", 
          "-XX:+UseStringDeduplication",   
          "-Xms64m",                       
          "-Xmx512m",                      
          "-XX:NewRatio=2"                 
        ]
      });

      console.log('Creating OPTIMIZED displayâ€¦');
      const container = document.getElementById('gameContainer');
      cheerpjCreateDisplay(800, 850, container);
      await new Promise(r => setTimeout(r, 200));

      console.log('Running OPTIMIZED game JARâ€¦');
      await cheerpjRunJar("/app/KallenSelbyJoustGame/JoustGame.jar");

      // super-lightweight input handling
      const canvas = document.querySelector('canvas');
      if (canvas) {
        canvas.style.display = 'block';
        canvas.tabIndex = 0;
        canvas.focus();

        const keyHandler = e => {
          const keys = ['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','Space','KeyN'];
          if (keys.includes(e.code)) {
            e.preventDefault();
            e.stopImmediatePropagation();
          }
        };
        canvas.addEventListener('keydown', keyHandler, { passive: false, capture: true });
        canvas.addEventListener('keyup',   keyHandler, { passive: false, capture: true });

        canvas.addEventListener('click', () => {
          canvas.focus();
          document.getElementById('instructions').style.opacity = '0.5';
        }, { passive: true });

        // keep focus alive
        setInterval(() => {
          if (document.activeElement !== canvas) canvas.focus();
        }, 2000);

        // more accurate FPS via requestAnimationFrame
        let frames = 0;
        let t0 = performance.now();
        function tick() {
          frames++;
          const t1 = performance.now();
          if (t1 - t0 >= 1000) {
            console.log(`FPS: ${(frames*1000/(t1-t0)).toFixed(1)}`);
            frames = 0; t0 = t1;
          }
          requestAnimationFrame(tick);
        }
        requestAnimationFrame(tick);
      }

      document.getElementById('loading').style.display = 'none';
      
    } catch (e) {
      console.error('CheerpJ Error:', e);
      document.getElementById('loading').innerHTML =
        `<div style="color: #ff6b6b;">Error: ${e.message}</div>
         <div style="font-size:14px; margin-top:10px;">
           Try refreshing (F5) or check console.
         </div>`;
    }
  </script>

  <style>
    html, body {
      margin:0; padding:10px; min-height:100vh;
      background:#111; display:flex;
      flex-direction:column; align-items:center;
      justify-content:center; font-family:Arial,sans-serif;
      color:#fff;
    }
    #loading { font-size:18px; margin-bottom:20px; text-align:center; }
    #loading small { color:#ffeb3b; font-size:12px; display:block; margin-top:5px; }
    #instructions {
      color:#ffeb3b; background:rgba(0,0,0,0.9);
      padding:10px 20px; border-radius:6px;
      font-size:14px; font-weight:bold;
      margin-bottom:15px; text-align:center;
      border:2px solid #ffeb3b; transition:opacity .3s;
      max-width:900px; box-shadow:0 0 10px rgba(255,235,59,0.3);
    }
    #gameContainer {
      border:2px solid #555; background:#000;
      box-shadow:0 0 30px rgba(255,255,255,0.1);
      position:relative; min-width:800px; min-height:850px;
      overflow:visible;
    }
    canvas { outline:none!important; display:block!important; }
    #gameContainer::before {
      content:"ðŸš€ MAX PERFORMANCE MODE";
      position:absolute; top:-25px; left:0;
      color:#4caf50; font-size:11px; font-weight:bold;
    }
    @media (max-width:950px) {
      #gameContainer { transform:scale(0.85); transform-origin:center; }
    }
    @media (max-width:800px) {
      #gameContainer { transform:scale(0.75); }
      #instructions { font-size:12px; padding:8px 16px; }
    }
  </style>
</body>
</html>
